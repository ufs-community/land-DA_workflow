workflow:
  attrs:
    realtime: false
    scheduler: slurm
  cycledef:
    - attrs:
        group: epic
      spec: 200001030000 200001030000 24:00:00
  entities:
    MACHINE: "hera"
    SCHED: "slurm"
    ACCOUNT: "nems"
    EXP_NAME: "LETKF"
    EXP_BASEDIR: "/scratch2/NAGAPE/epic/{USER}/landda_test"
    JEDI_INSTALL: "/scratch2/NAGAPE/epic/UFS_Land-DA/jedi"
    LANDDA_INPUTS: "/scratch2/NAGAPE/epic/UFS_Land-DA/inputs"
    FORCING: "gswp3"
    RES: "96"
    FCSTHR: "24"
    NPROCS_ANALYSIS: "6"
    NPROCS_FORECAST: "6"
    OBS_TYPES: "GHCN"
    fv3bundle_vn: "psl_develop"
    DAtype: "letkfoi_snow"
    SNOWDEPTHVAR: "snwdph"
    TSTUB: "oro_C96.mx100"
    NET: "landda"
    envir: "test"
    model_ver: "v1.2.1"
    HOMElandda: "&EXP_BASEDIR;/land-DA_workflow"
    PTMP: "&EXP_BASEDIR;/ptmp"
    COMROOT: "&PTMP;/&envir;/com"
    DATAROOT: "&PTMP;/&envir;/tmp"
    KEEPDATA: "YES"
    WORKDIR: "&EXP_BASEDIR;/workdir/run_&FORCING;"
    LOGDIR: "&COMROOT;/output/logs/run_&FORCING;"
    PATHRT: "&EXP_BASEDIR;"
    PDY:  "<cyclestr>@Y@m@d</cyclestr>"
    cyc: "<cyclestr>@H</cyclestr>"
    SLASH_ENSMEM_SUBDIR: ""
    PTIME:  "<cyclestr offset='-24:00:00'>@Y@m@d@H</cyclestr>"
    NTIME:  "<cyclestr offset='24:00:00'>@Y@m@d@H</cyclestr>"
  log: "&LOGDIR;/workflow.log"
  tasks:
    task_prep_exp:
      envars:
        MACHINE: "&MACHINE;"
        SCHED: "&SCHED;"
        ACCOUNT: "&ACCOUNT;"
        EXP_NAME: "&EXP_NAME;"
        LANDDA_INPUTS: "&LANDDA_INPUTS;"
        ATMOS_FORC: "&FORCING;"
        RES: "&RES;"
        TSTUB: "&TSTUB;"
        WORKDIR: "&WORKDIR;"
        model_ver: "&model_ver;"
        HOMElandda: "&HOMElandda;"
        COMROOT: "&COMROOT;"
        DATAROOT: "&DATAROOT;"
        KEEPDATA: "&KEEPDATA;"
        PDY: "&PDY;"
        cyc: "&cyc;"
        SLASH_ENSMEM_SUBDIR: "&SLASH_ENSMEM_SUBDIR;"
        PTIME: "&PTIME;"
      account: "&ACCOUNT;"
      command: '&HOMElandda;/parm/task_load_modules_run_jjob.sh "prep_exp" "&HOMElandda;" "&MACHINE;"'
      jobname: prep_exp
      cores: 1
      walltime: 00:02:00
      queue: batch
      join: "&LOGDIR;/prep_exp.log"
    task_prep_obs:
      envars:
        OBS_TYPES: "&OBS_TYPES;"
        MACHINE: "&MACHINE;"
        SCHED: "&SCHED;"
        ACCOUNT: "&ACCOUNT;"
        EXP_NAME: "&EXP_NAME;"
        LANDDA_INPUTS: "&LANDDA_INPUTS;"
        ATMOS_FORC: "&FORCING;"
        WORKDIR: "&WORKDIR;"
        model_ver: "&model_ver;"
        HOMElandda: "&HOMElandda;"
        COMROOT: "&COMROOT;"
        DATAROOT: "&DATAROOT;"
        KEEPDATA: "&KEEPDATA;"
        PDY: "&PDY;"
        cyc: "&cyc;"
        SLASH_ENSMEM_SUBDIR: "&SLASH_ENSMEM_SUBDIR;"
        PTIME: "&PTIME;"
      account: "&ACCOUNT;"
      command: '&HOMElandda;/parm/task_load_modules_run_jjob.sh "prep_obs" "&HOMElandda;" "&MACHINE;"'
      jobname: prep_obs
      cores: 1
      walltime: 00:02:00
      queue: batch
      join: "&LOGDIR;/prep_obs.log"
      dependency:
        taskdep:
          attrs:
            task: prep_exp
    task_prep_bmat:
      envars:
        MACHINE: "&MACHINE;"
        SCHED: "&SCHED;"
        ACCOUNT: "&ACCOUNT;"
        EXP_NAME: "&EXP_NAME;"
        LANDDA_INPUTS: "&LANDDA_INPUTS;"
        ATMOS_FORC: "&FORCING;"
        WORKDIR: "&WORKDIR;"
        model_ver: "&model_ver;"
        HOMElandda: "&HOMElandda;"
        COMROOT: "&COMROOT;"
        DATAROOT: "&DATAROOT;"
        KEEPDATA: "&KEEPDATA;"
        PDY: "&PDY;"
        cyc: "&cyc;"
        SLASH_ENSMEM_SUBDIR: "&SLASH_ENSMEM_SUBDIR;"
        PTIME: "&PTIME;"
        fv3bundle_vn: "&fv3bundle_vn;"
        DAtype: "&DAtype;"
        SNOWDEPTHVAR: "&SNOWDEPTHVAR;"
      account: "&ACCOUNT;"
      command: '&HOMElandda;/parm/task_load_modules_run_jjob.sh "prep_bmat" "&HOMElandda;" "&MACHINE;"'
      jobname: prep_bmat
      cores: 1
      walltime: 00:02:00
      queue: batch
      join: "&LOGDIR;/prep_bmat.log"
      dependency:
        taskdep:
          attrs:
            task: prep_obs
    task_analysis:
      envars:
        OBS_TYPES: "&OBS_TYPES;"
        MACHINE: "&MACHINE;"
        SCHED: "&SCHED;"
        ACCOUNT: "&ACCOUNT;"
        EXP_NAME: "&EXP_NAME;"
        LANDDA_INPUTS: "&LANDDA_INPUTS;"
        ATMOS_FORC: "&FORCING;"
        RES: "&RES;"
        TSTUB: "&TSTUB;"
        WORKDIR: "&WORKDIR;"
        model_ver: "&model_ver;"
        HOMElandda: "&HOMElandda;"
        COMROOT: "&COMROOT;"
        DATAROOT: "&DATAROOT;"
        KEEPDATA: "&KEEPDATA;"
        PDY: "&PDY;"
        cyc: "&cyc;"
        SLASH_ENSMEM_SUBDIR: "&SLASH_ENSMEM_SUBDIR;"
        PTIME: "&PTIME;"
        NTIME: "&NTIME;"
        fv3bundle_vn: "&fv3bundle_vn;"
        DAtype: "&DAtype;"
        SNOWDEPTHVAR: "&SNOWDEPTHVAR;"
        NPROC_JEDI: "&NPROCS_ANALYSIS;"
        JEDI_INSTALL: "&JEDI_INSTALL;"
      account: "&ACCOUNT;"
      command: '&HOMElandda;/parm/task_load_modules_run_jjob.sh "analysis" "&HOMElandda;" "&MACHINE;"'
      jobname: analysis
      nodes: "1:ppn=&NPROCS_ANALYSIS;"
      walltime: 00:15:00
      queue: batch
      join: "&LOGDIR;/analysis.log"
      dependency:
        taskdep:
          attrs:
            task: prep_bmat
    task_forecast:
      envars:
        OBS_TYPES: "&OBS_TYPES;"
        MACHINE: "&MACHINE;"
        SCHED: "&SCHED;"
        ACCOUNT: "&ACCOUNT;"
        EXP_NAME: "&EXP_NAME;"
        LANDDA_INPUTS: "&LANDDA_INPUTS;"
        ATMOS_FORC: "&FORCING;"
        RES: "&RES;"
        TSTUB: "&TSTUB;"
        WORKDIR: "&WORKDIR;"
        model_ver: "&model_ver;"
        HOMElandda: "&HOMElandda;"
        COMROOT: "&COMROOT;"
        DATAROOT: "&DATAROOT;"
        KEEPDATA: "&KEEPDATA;"
        LOGDIR: "&LOGDIR;"
        PDY: "&PDY;"
        cyc: "&cyc;"
        SLASH_ENSMEM_SUBDIR: "&SLASH_ENSMEM_SUBDIR;"
        PTIME: "&PTIME;"
        NTIME: "&NTIME;"
        fv3bundle_vn: "&fv3bundle_vn;"
        DAtype: "&DAtype;"
        SNOWDEPTHVAR: "&SNOWDEPTHVAR;"
        JEDI_INSTALL: "&JEDI_INSTALL;"
        FCSTHR: "&FCSTHR;"
      account: "&ACCOUNT;"
      command: '&HOMElandda;/parm/task_load_modules_run_jjob.sh "forecast" "&HOMElandda;" "&MACHINE;"'
      jobname: forecast
      nodes: "1:ppn=&NPROCS_FORECAST;"
      walltime: 00:45:00
      queue: batch
      join: "&LOGDIR;/forecast.log"
      dependency:
        taskdep:
          attrs:
            task: analysis
